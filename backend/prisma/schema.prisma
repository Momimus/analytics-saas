// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum EnrollmentStatus {
  REQUESTED
  ACTIVE
  REVOKED
}

enum DeletionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(STUDENT)
  fullName     String?
  phone        String?
  phoneCountry String?
  phoneE164    String?
  address      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  enrollments  Enrollment[]
  progress     LessonProgress[]
  resetTokens  PasswordResetToken[]
  createdCourses Course[] @relation("CourseCreator")
  deletionRequests DeletionRequest[] @relation("DeletionRequestRequestedBy")
  deletionDecisions DeletionRequest[] @relation("DeletionRequestDecidedBy")
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String?
  level       String?
  imageUrl    String?
  isPublished Boolean  @default(false)
  archivedAt  DateTime?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  enrollments Enrollment[]
  deletionRequests DeletionRequest[]
  createdBy   User?    @relation("CourseCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([createdById])
  @@index([isPublished])
  @@index([archivedAt])
}

model Lesson {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  videoUrl  String?
  pdfUrl    String?
  createdAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@index([courseId])
}

model Enrollment {
  id        String           @id @default(cuid())
  userId    String
  courseId  String
  status    EnrollmentStatus @default(REQUESTED)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([status])
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

model DeletionRequest {
  id            String                @id @default(cuid())
  courseId       String
  requestedById  String
  reason         String
  status         DeletionRequestStatus @default(PENDING)
  adminNote      String?
  createdAt      DateTime              @default(now())
  decidedAt      DateTime?
  decidedById    String?

  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  requestedBy User   @relation("DeletionRequestRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  decidedBy   User?  @relation("DeletionRequestDecidedBy", fields: [decidedById], references: [id], onDelete: SetNull)

  @@index([courseId])
  @@index([requestedById])
  @@index([status])
}
